# BPMN ビジュアルエディタ実装調査レポート

**作成日**: 2025年10月23日  
**調査者**: Development Team  
**目的**: bpmn-jsとelkjsを使用したBPMNビジュアルエディタの実装可能性と工数見積もり

---

## 📦 ライブラリ状況

### インストール済みライブラリ

| ライブラリ | バージョン | 用途 |
|----------|----------|------|
| bpmn-js | ^18.7.0 | BPMN図の表示・編集エンジン |
| elkjs | ^0.11.0 | グラフ自動レイアウトエンジン |

**結論**: 必要なライブラリは既にインストール済み。追加インストール不要。

---

## 🎯 実装スコープ

### Phase 1: 基本表示機能（最小限）

**機能**:
- Processデータ → BPMN XML変換
- bpmn-jsでのBPMN図表示（読み取り専用）
- 基本的なBPMN要素の視覚化（タスク、イベント、ゲートウェイ）

**必要なコンポーネント**:
1. `BpmnViewer.tsx` - bpmn-jsラッパーコンポーネント
2. `ProcessToBpmnConverter.ts` - Process → BPMN XML変換ロジック
3. BPMN表示ページ（`/projects/[id]/bpmn`）

**工数見積もり**: **2-3日**
- bpmn-js統合: 0.5日
- データ変換ロジック: 1日
- UI実装・デバッグ: 0.5-1.5日

---

### Phase 2: 自動レイアウト機能

**機能**:
- ELK (Eclipse Layout Kernel) による自動レイアウト
- Process配置の自動最適化
- レイアウトアルゴリズム選択（layered/stress/mrtree）

**実装内容**:
1. `BpmnLayoutService.ts` - ELK統合サービス
2. Process → ELKグラフ変換
3. ELKレイアウト結果 → BPMN座標反映
4. 「自動整形」ボタンUI

**工数見積もり**: **2-3日**
- ELK統合: 1日
- グラフ変換ロジック: 1日
- UI・デバッグ: 0.5-1日

---

### Phase 3: 編集機能（高度）

**機能**:
- bpmn-jsのModelerモード（編集可能）
- ドラッグ&ドロップでのBPMN要素配置
- BPMN編集 → Processデータ逆変換
- リアルタイム同期

**実装内容**:
1. `BpmnModeler.tsx` - 編集可能エディタ
2. `BpmnToProcessConverter.ts` - BPMN XML → Process変換
3. 双方向同期ロジック
4. 編集履歴管理

**工数見積もり**: **5-7日**
- Modeler統合: 1-2日
- 逆変換ロジック: 2-3日
- 同期システム: 1-2日
- テスト・デバッグ: 1日

---

## 🏗️ アーキテクチャ設計

### データフロー

```
Process (DB)
    ↓
ProcessToBpmnConverter
    ↓
BPMN XML
    ↓
bpmn-js Viewer/Modeler
    ↓ (編集時)
BPMN XML
    ↓
BpmnToProcessConverter
    ↓
Process (DB)
```

### ELKレイアウトフロー

```
Process (DB)
    ↓
ProcessToElkGraph
    ↓
ELK Graph JSON
    ↓
elkjs.layout()
    ↓
Positioned Graph
    ↓
BPMN座標更新
    ↓
bpmn-js表示
```

---

## 📊 総工数見積もり

| フェーズ | 機能 | 工数 | 優先度 |
|---------|------|------|--------|
| Phase 1 | 基本表示 | 2-3日 | HIGH |
| Phase 2 | 自動レイアウト | 2-3日 | MEDIUM |
| Phase 3 | 編集機能 | 5-7日 | LOW |
| **合計** | | **9-13日** | |

---

## 🚨 技術的課題と対策

### 課題1: ProcessデータとBPMN標準の差異

**問題**: 当プロジェクトのProcess型はBPMN 2.0標準を拡張しているが、完全互換ではない

**対策**:
- カスタムBPMN拡張プロパティを使用（`custom:` namespace）
- メタデータをBPMN Documentationに埋め込み
- 可逆変換を保証するマッピングテーブル作成

### 課題2: レイアウト品質

**問題**: ELKの自動レイアウトが必ずしも最適とは限らない

**対策**:
- 複数アルゴリズム対応（layered/stress/mrtree）
- 手動調整機能の提供（Phase 3）
- レイアウト設定のプリセット保存

### 課題3: パフォーマンス

**問題**: 大規模BPMN図（100+ 要素）でのレンダリング性能

**対策**:
- 仮想化レンダリング（react-window統合）
- 遅延読み込み
- WebWorkerでのレイアウト計算

---

## 💡 推奨実装順序

### ステップ1: 基本表示のみ（Phase 1）
- **期間**: 2-3日
- **成果物**: BPMN図の読み取り専用表示
- **ユーザー価値**: 工程表をBPMN図として可視化できる

### ステップ2: 自動レイアウト追加（Phase 2）
- **期間**: 2-3日
- **成果物**: 「自動整形」ボタンで綺麗な図に
- **ユーザー価値**: 手動配置不要で見やすい図を自動生成

### ステップ3: 編集機能追加（Phase 3）
- **期間**: 5-7日
- **成果物**: BPMN図上での直接編集
- **ユーザー価値**: ビジュアルエディタで直感的な工程設計

---

## 🎯 推奨アクション

### 即座に実装可能（Phase 1）
1. `BpmnViewer.tsx` コンポーネント作成
2. 基本的なProcess → BPMN変換ロジック
3. BPMN表示ページ追加

### Phase 10として計画
- **Phase 2 + Phase 3**: 自動レイアウト + 編集機能
- **理由**: 
  - 現在のPhase 9（フラット構造）が優先
  - BPMN編集は高度な機能で、基本機能完成後に実装が望ましい
  - 自動レイアウトの品質調整に時間がかかる可能性

---

## 📝 結論

### 現状
- ✅ 必要ライブラリ既にインストール済み（bpmn-js, elkjs）
- ✅ ProcessデータにBPMN 2.0項目統合済み
- ✅ 技術的な実装準備完了

### 推奨
**Phase 1（基本表示）のみ先行実装、Phase 2-3はPhase 10へ延期**

**理由**:
1. Phase 1だけで実用的な価値がある（工程表の視覚化）
2. 2-3日で実装可能
3. 編集機能は工程管理UI（既存）で十分カバーされている
4. 自動レイアウトは「あると便利」だが必須ではない

**次のアクション**:
- Phase 1実装を開始するか、他の優先タスク（マニュアル編集UI等）を先に完了させるか判断
